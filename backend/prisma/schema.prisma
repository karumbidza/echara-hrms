generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  currency  String   @default("USD")
  timezone  String   @default("Africa/Harare")
  
  // Company details
  companyEmail    String?
  companyPhone    String?
  companyAddress  String?
  logo            String?
  website         String?
  
  // Subscription
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  organizations   Organization[]
  employees       Employee[]
  departments     Department[]
  payrollRuns     PayrollRun[]
  taxTables       TaxTable[]
  taxCalculations TaxCalculation[]
  nssaRates       NSSARate[]
  currencyRates   CurrencyRate[]
  auditLogs       AuditLog[]
  subscriptions   Subscription[]
  payments        Payment[]
  leavePolicy     LeavePolicy?
  leaveRequests   LeaveRequest[]

  @@map("tenants")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String
  role      UserRole @default(EMPLOYEE)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations (tenantId is optional for SUPER_ADMIN)
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Audit relations
  createdPayrollRuns   PayrollRun[] @relation("PayrollCreator")
  submittedPayrollRuns PayrollRun[] @relation("PayrollSubmitter")
  approvedPayrollRuns  PayrollRun[] @relation("PayrollApprover")
  auditLogs            AuditLog[]
  timesheets           Timesheet[]
  reviewedLeaveRequests LeaveRequest[] @relation("LeaveReviewer")

  @@map("users")
}

model Organization {
  id         String   @id @default(uuid())
  name       String
  address    String?
  phone      String?
  email      String?
  taxNumber  String?
  nssaNumber String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  departments Department[]

  @@map("organizations")
}

model Department {
  id        String   @id @default(uuid())
  name      String
  code      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  employees Employee[]

  @@map("departments")
}

model Employee {
  id             String    @id @default(uuid())
  employeeNumber String    @unique
  firstName      String
  lastName       String
  nationalId     String?   // ENCRYPTED - sensitive PII
  dateOfBirth    DateTime?
  hireDate       DateTime?
  email          String?
  phone          String?
  address        String?

  // Employment details
  employmentType   EmploymentType @default(FULL_TIME)
  jobTitle         String
  payFrequency     PayFrequency   @default(MONTHLY)
  basicSalary      Float          @default(0) // ENCRYPTED - sensitive financial
  currency         String         @default("USD") // Display currency
  contractCurrency String         @default("USD") // Contract currency for tax calculations
  bankName         String?
  bankAccount      String?        // ENCRYPTED - sensitive financial
  nssaNumber       String?        // ENCRYPTED - sensitive PII

  // Default Monthly Allowances/Deductions
  defaultHousingAllowance   Float @default(0)
  defaultTransportAllowance Float @default(0)
  defaultMealAllowance      Float @default(0)
  defaultOtherAllowances    Float @default(0)
  defaultPensionContribution Float @default(0)
  defaultMedicalAid         Float @default(0)
  defaultMonthlyLeaveRate   Float @default(0) // Monthly leave allowance (gets reduced by days taken)

  // YTD Tracking
  ytdGross   Float @default(0)
  ytdTaxable Float @default(0)
  ytdPaye    Float @default(0)
  ytdNssa    Float @default(0)
  ytdNetPay  Float @default(0)
  ytdYear    Int? // Year for YTD tracking

  // Document uploads
  photoPath          String?
  nationalIdPath     String?
  driversLicensePath String?

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  payslips        Payslip[]
  timesheets      Timesheet[]
  leaveRequests   LeaveRequest[]
  leaveBalances   LeaveBalance[]
  salaryHistory   SalaryHistory[]
  payrollLines    PayrollLine[]
  taxCalculations TaxCalculation[]

  @@map("employees")
}

model PayrollRun {
  id          String        @id @default(uuid())
  periodStart DateTime
  periodEnd   DateTime
  status      PayrollStatus @default(DRAFT)
  totalGross  Float         @default(0)
  totalNet    Float         @default(0)
  runDate     DateTime      @default(now())
  
  // Approval workflow
  submittedAt DateTime?
  submittedBy String?
  submitter   User?    @relation("PayrollSubmitter", fields: [submittedBy], references: [id])
  
  approvedAt   DateTime?
  approvedBy   String?
  approver     User?    @relation("PayrollApprover", fields: [approvedBy], references: [id])
  
  rejectedAt   DateTime?
  rejectionReason String?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("PayrollCreator", fields: [createdById], references: [id])

  payslips        Payslip[]
  taxCalculations TaxCalculation[]

  @@map("payroll_runs")
}

model Payslip {
  id          String   @id @default(uuid())
  periodStart DateTime
  periodEnd   DateTime
  payDate     DateTime

  // Salary components
  grossSalary Float @default(0)
  basicSalary Float @default(0)
  allowances  Float @default(0)
  bonuses     Float @default(0)
  overtime    Float @default(0)

  // Deductions
  preTaxDeductions Float @default(0)
  taxableIncome    Float @default(0)
  paye             Float @default(0)
  aidsLevy         Float @default(0)
  nssaEmployee     Float @default(0)
  otherDeductions  Float @default(0)
  totalDeductions  Float @default(0)

  // Net and employer costs
  netSalary     Float @default(0)
  nssaEmployer  Float @default(0)
  employerTotal Float @default(0)

  // Currency and tracking
  currency         String @default("USD")
  contractCurrency String @default("USD")
  exchangeRate     Float? // If paid in different currency

  // YTD at time of payslip
  ytdGross   Float @default(0)
  ytdTaxable Float @default(0)
  ytdPaye    Float @default(0)
  ytdNssa    Float @default(0)
  ytdNetPay  Float @default(0)

  // Metadata
  details      Json? // Detailed breakdown
  pdfPath      String? // Path to generated PDF
  isDelivered  Boolean  @default(false)
  isAdjustment Boolean  @default(false) // Retroactive adjustment flag
  createdAt    DateTime @default(now())

  // Relations
  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  payrollLines PayrollLine[]

  @@map("payslips")
}

model TaxTable {
  id            String       @id @default(uuid())
  name          String // e.g., "USD Monthly 2025"
  currency      String       @default("USD") // USD or ZWL
  payFrequency  PayFrequency
  type          TaxType      @default(PAYE)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  isActive      Boolean      @default(true)
  brackets      Json // [{min: 0, max: 100, rate: 0, deduct: 0}, ...]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  taxCalculations TaxCalculation[]

  @@map("tax_tables")
}

model TaxCalculation {
  id              String   @id @default(uuid())
  taxableIncome   Float
  currency        String
  payFrequency    PayFrequency
  payeAmount      Float    @default(0)
  aidsLevy        Float    @default(0)
  totalTax        Float    @default(0)
  calculationDate DateTime @default(now())

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  payrollRunId String?
  payrollRun   PayrollRun? @relation(fields: [payrollRunId], references: [id])

  taxTableId String?
  taxTable   TaxTable? @relation(fields: [taxTableId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tax_calculations")
}

model NSSARate {
  id            String    @id @default(uuid())
  name          String // e.g., "NSSA Rates 2025"
  effectiveFrom DateTime
  effectiveTo   DateTime?
  employeeRate  Float // e.g., 0.045 for 4.5%
  employerRate  Float // e.g., 0.045 for 4.5%
  maxCap        Float? // Maximum salary cap for NSSA
  currency      String    @default("USD")
  createdAt     DateTime  @default(now())

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("nssa_rates")
}

model CurrencyRate {
  id            String   @id @default(uuid())
  fromCurrency  String // e.g., "ZWL"
  toCurrency    String // e.g., "USD"
  rate          Float // Conversion rate
  effectiveDate DateTime
  source        String? // e.g., "RBZ", "Manual"
  createdAt     DateTime @default(now())

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("currency_rates")
}

model PayrollLine {
  id          String          @id @default(uuid())
  lineType    PayrollLineType // BASIC_SALARY, ALLOWANCE, OVERTIME, BONUS, DEDUCTION, PAYE, NSSA_EMPLOYEE, NSSA_EMPLOYER, ADJUSTMENT
  description String
  amount      Float
  currency    String          @default("USD")
  isStatutory Boolean         @default(false)
  isTaxable   Boolean         @default(true)
  createdAt   DateTime        @default(now())

  // Relations
  payslipId String
  payslip   Payslip @relation(fields: [payslipId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("payroll_lines")
}

model SalaryHistory {
  id             String   @id @default(uuid())
  effectiveDate  DateTime
  previousSalary Float
  newSalary      Float
  currency       String
  reason         String? // e.g., "Annual Increment", "Promotion", "Adjustment"
  approvedBy     String?
  createdAt      DateTime @default(now())

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("salary_history")
}

model Timesheet {
  id            String          @id @default(uuid())
  date          DateTime
  clockIn       DateTime?
  clockOut      DateTime?
  regularHours  Float           @default(0)
  overtimeHours Float           @default(0)
  status        TimesheetStatus @default(PENDING)
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  approvedById String?
  approvedBy   User?   @relation(fields: [approvedById], references: [id])

  @@map("timesheets")
}

// Leave Management
model LeavePolicy {
  id        String   @id @default(uuid())
  
  // Annual leave settings
  annualLeaveDays      Int      @default(22)  // Zimbabwe standard
  carryOverDays        Int      @default(5)   // Max days to carry to next year
  
  // Sick leave settings
  sickLeaveDaysBeforeCert Int   @default(2)  // Days before medical cert required
  
  // Maternity leave
  maternityLeaveDays   Int      @default(98)  // 14 weeks
  
  // Paternity leave
  paternityLeaveDays   Int      @default(7)   // 1 week
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  tenantId String   @unique
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@map("leave_policies")
}

model LeaveBalance {
  id        String   @id @default(uuid())
  
  year      Int      // Leave year (2025, 2026, etc)
  
  // Annual leave
  annualTotal     Decimal  @default(22) @db.Decimal(5, 1)
  annualUsed      Decimal  @default(0)  @db.Decimal(5, 1)
  annualBalance   Decimal  @default(22) @db.Decimal(5, 1)
  annualCarryOver Decimal  @default(0)  @db.Decimal(5, 1)
  
  // Sick leave
  sickUsed        Decimal  @default(0)  @db.Decimal(5, 1)
  
  // Other leave
  maternityUsed   Decimal  @default(0)  @db.Decimal(5, 1)
  paternityUsed   Decimal  @default(0)  @db.Decimal(5, 1)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  @@unique([employeeId, year])
  @@map("leave_balances")
}

model LeaveRequest {
  id        String      @id @default(uuid())
  
  leaveType       LeaveType
  startDate       DateTime
  endDate         DateTime
  totalDays       Decimal     @db.Decimal(5, 1) // Working days (excludes weekends)
  halfDay         Boolean     @default(false)
  
  reason          String      // Employee's reason
  attachment      String?     // Medical cert, death cert, etc (file path)
  
  status          LeaveStatus @default(PENDING)
  
  // Approval workflow
  reviewedAt      DateTime?
  reviewNotes     String?     // Manager's approval/rejection notes
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  reviewedBy      String?
  reviewer        User?       @relation("LeaveReviewer", fields: [reviewedBy], references: [id])
  
  @@index([tenantId, status])
  @@index([employeeId, status])
  @@map("leave_requests")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  table     String
  recordId  String
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

// Enums
enum UserRole {
  SUPER_ADMIN
  ADMIN
  PAYROLL_OFFICER
  MANAGER
  EMPLOYEE
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  CASUAL
}

enum PayFrequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
}

enum PayrollStatus {
  DRAFT       // Initial state, being prepared
  PENDING     // Submitted for approval
  APPROVED    // Approved by manager
  PROCESSING  // Being processed/paid
  COMPLETED   // Payment completed
  REJECTED    // Rejected by approver
  FAILED      // Processing failed
}

enum TaxType {
  PAYE
  NSSA
  AIDS_LEVY
}

enum TimesheetStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LeaveType {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  COMPASSIONATE
  UNPAID
  STUDY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrollLineType {
  BASIC_SALARY
  ALLOWANCE
  OVERTIME
  BONUS
  DEDUCTION
  PAYE
  AIDS_LEVY
  NSSA_EMPLOYEE
  NSSA_EMPLOYER
  ADJUSTMENT
  OTHER
}

// Subscription Plans
model Plan {
  id          String   @id @default(uuid())
  name        String   // Starter, Professional, Enterprise
  slug        String   @unique
  description String?
  
  // Pricing
  priceUSD    Float    @default(0)
  priceZWL    Float    @default(0)
  billingCycle String  @default("MONTHLY") // MONTHLY, ANNUAL
  
  // Limits
  maxEmployees Int     @default(10)
  maxUsers     Int     @default(3)
  
  // Features
  features    Json?    // Array of features
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  subscriptions Subscription[]
  
  @@map("plans")
}

// Company Subscriptions
model Subscription {
  id        String   @id @default(uuid())
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  planId    String
  plan      Plan     @relation(fields: [planId], references: [id])
  
  status    SubscriptionStatus @default(ACTIVE)
  
  // Billing
  startDate     DateTime
  endDate       DateTime
  nextBillingDate DateTime?
  
  // Pricing at time of subscription
  amountUSD Float
  amountZWL Float
  currency  String @default("USD")
  
  cancelledAt DateTime?
  cancelReason String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  payments Payment[]
  
  @@map("subscriptions")
}

// Payment Transactions
model Payment {
  id        String   @id @default(uuid())
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  
  // Payment details
  amount       Float
  currency     String  @default("USD")
  status       PaymentStatus @default(PENDING)
  method       String? // PAYNOW, ECOCASH, BANK_TRANSFER
  
  // Paynow integration
  paynowReference String? @unique
  pollUrl         String?
  
  // Manual verification (for bank transfers, Ecocash, etc)
  verifiedAt  DateTime?
  verifiedBy  String?
  notes       String?
  
  // Metadata
  description String?
  metadata    Json?
  
  // Timestamps
  paidAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("payments")
}

// Quote Requests (from potential customers)
model QuoteRequest {
  id        String   @id @default(uuid())
  
  // Company details
  companyName    String
  companyEmail   String
  companyPhone   String?
  contactPerson  String
  
  // Requirements
  estimatedEmployees Int
  estimatedUsers     Int
  industry           String?
  additionalNotes    String?
  
  // Preferred plan
  preferredPlan String? // Starter, Professional, Enterprise
  currency      String  @default("USD")
  
  // Status
  status        QuoteStatus @default(PENDING)
  respondedAt   DateTime?
  respondedBy   String?
  quoteAmount   Float?
  quoteCurrency String?
  quoteNotes    String?
  
  // Conversion
  convertedToTenant Boolean @default(false)
  tenantId          String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("quote_requests")
}

// Platform Settings (Super Admin Only)
model PlatformSettings {
  id        String   @id @default(uuid())
  
  // Tax Settings (Zimbabwe ZIMRA)
  taxYear           Int      @default(2025)
  taxBrackets       Json     // Array of {min, max, rate, deduction}
  aidsLevyRate      Float    @default(3.0) // % of PAYE
  
  // NSSA Settings
  nssaEmployeeRate  Float    @default(3.0)  // % of gross
  nssaEmployerRate  Float    @default(3.5)  // % of gross
  nssaLowerLimit    Float    @default(0)
  nssaUpperLimit    Float    @default(1000) // Monthly cap in USD
  
  // Other Settings
  minimumWage       Float    @default(100)  // USD per month
  
  // Audit
  updatedBy String?
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
  
  @@map("platform_settings")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum QuoteStatus {
  PENDING
  REVIEWED
  SENT
  ACCEPTED
  REJECTED
}

