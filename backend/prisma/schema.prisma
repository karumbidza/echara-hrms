generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  currency  String   @default("USD")
  timezone  String   @default("Africa/Harare")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  organizations   Organization[]
  employees       Employee[]
  departments     Department[]
  payrollRuns     PayrollRun[]
  taxTables       TaxTable[]
  taxCalculations TaxCalculation[]
  nssaRates       NSSARate[]
  currencyRates   CurrencyRate[]
  auditLogs       AuditLog[]

  @@map("tenants")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String
  role      UserRole @default(EMPLOYEE)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Audit relations
  createdPayrollRuns PayrollRun[]
  auditLogs          AuditLog[]
  timesheets         Timesheet[]
  leaves             Leave[]

  @@map("users")
}

model Organization {
  id         String   @id @default(uuid())
  name       String
  address    String?
  phone      String?
  email      String?
  taxNumber  String?
  nssaNumber String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  departments Department[]

  @@map("organizations")
}

model Department {
  id        String   @id @default(uuid())
  name      String
  code      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  employees Employee[]

  @@map("departments")
}

model Employee {
  id             String    @id @default(uuid())
  employeeNumber String    @unique
  firstName      String
  lastName       String
  nationalId     String?
  dateOfBirth    DateTime?
  hireDate       DateTime?
  email          String?
  phone          String?
  address        String?

  // Employment details
  employmentType   EmploymentType @default(FULL_TIME)
  jobTitle         String
  payFrequency     PayFrequency   @default(MONTHLY)
  basicSalary      Float          @default(0)
  currency         String         @default("USD") // Display currency
  contractCurrency String         @default("USD") // Contract currency for tax calculations
  bankName         String?
  bankAccount      String?
  nssaNumber       String?

  // YTD Tracking
  ytdGross   Float @default(0)
  ytdTaxable Float @default(0)
  ytdPaye    Float @default(0)
  ytdNssa    Float @default(0)
  ytdNetPay  Float @default(0)
  ytdYear    Int? // Year for YTD tracking

  // Document uploads
  photoPath          String?
  nationalIdPath     String?
  driversLicensePath String?

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  payslips        Payslip[]
  timesheets      Timesheet[]
  leaves          Leave[]
  salaryHistory   SalaryHistory[]
  payrollLines    PayrollLine[]
  taxCalculations TaxCalculation[]

  @@map("employees")
}

model PayrollRun {
  id          String        @id @default(uuid())
  periodStart DateTime
  periodEnd   DateTime
  status      PayrollStatus @default(QUEUED)
  totalGross  Float         @default(0)
  totalNet    Float         @default(0)
  runDate     DateTime      @default(now())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  payslips        Payslip[]
  taxCalculations TaxCalculation[]

  @@map("payroll_runs")
}

model Payslip {
  id          String   @id @default(uuid())
  periodStart DateTime
  periodEnd   DateTime
  payDate     DateTime

  // Salary components
  grossSalary Float @default(0)
  basicSalary Float @default(0)
  allowances  Float @default(0)
  bonuses     Float @default(0)
  overtime    Float @default(0)

  // Deductions
  preTaxDeductions Float @default(0)
  taxableIncome    Float @default(0)
  paye             Float @default(0)
  aidsLevy         Float @default(0)
  nssaEmployee     Float @default(0)
  otherDeductions  Float @default(0)
  totalDeductions  Float @default(0)

  // Net and employer costs
  netSalary     Float @default(0)
  nssaEmployer  Float @default(0)
  employerTotal Float @default(0)

  // Currency and tracking
  currency         String @default("USD")
  contractCurrency String @default("USD")
  exchangeRate     Float? // If paid in different currency

  // YTD at time of payslip
  ytdGross   Float @default(0)
  ytdTaxable Float @default(0)
  ytdPaye    Float @default(0)
  ytdNssa    Float @default(0)
  ytdNetPay  Float @default(0)

  // Metadata
  details      Json? // Detailed breakdown
  pdfPath      String? // Path to generated PDF
  isDelivered  Boolean  @default(false)
  isAdjustment Boolean  @default(false) // Retroactive adjustment flag
  createdAt    DateTime @default(now())

  // Relations
  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  payrollLines PayrollLine[]

  @@map("payslips")
}

model TaxTable {
  id            String       @id @default(uuid())
  name          String // e.g., "USD Monthly 2025"
  currency      String       @default("USD") // USD or ZWL
  payFrequency  PayFrequency
  type          TaxType      @default(PAYE)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  isActive      Boolean      @default(true)
  brackets      Json // [{min: 0, max: 100, rate: 0, deduct: 0}, ...]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  taxCalculations TaxCalculation[]

  @@map("tax_tables")
}

model TaxCalculation {
  id              String   @id @default(uuid())
  taxableIncome   Float
  currency        String
  payFrequency    PayFrequency
  payeAmount      Float    @default(0)
  aidsLevy        Float    @default(0)
  totalTax        Float    @default(0)
  calculationDate DateTime @default(now())

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  payrollRunId String?
  payrollRun   PayrollRun? @relation(fields: [payrollRunId], references: [id])

  taxTableId String?
  taxTable   TaxTable? @relation(fields: [taxTableId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tax_calculations")
}

model NSSARate {
  id            String    @id @default(uuid())
  name          String // e.g., "NSSA Rates 2025"
  effectiveFrom DateTime
  effectiveTo   DateTime?
  employeeRate  Float // e.g., 0.045 for 4.5%
  employerRate  Float // e.g., 0.045 for 4.5%
  maxCap        Float? // Maximum salary cap for NSSA
  currency      String    @default("USD")
  createdAt     DateTime  @default(now())

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("nssa_rates")
}

model CurrencyRate {
  id            String   @id @default(uuid())
  fromCurrency  String // e.g., "ZWL"
  toCurrency    String // e.g., "USD"
  rate          Float // Conversion rate
  effectiveDate DateTime
  source        String? // e.g., "RBZ", "Manual"
  createdAt     DateTime @default(now())

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("currency_rates")
}

model PayrollLine {
  id          String          @id @default(uuid())
  lineType    PayrollLineType // BASIC_SALARY, ALLOWANCE, OVERTIME, BONUS, DEDUCTION, PAYE, NSSA_EMPLOYEE, NSSA_EMPLOYER, ADJUSTMENT
  description String
  amount      Float
  currency    String          @default("USD")
  isStatutory Boolean         @default(false)
  isTaxable   Boolean         @default(true)
  createdAt   DateTime        @default(now())

  // Relations
  payslipId String
  payslip   Payslip @relation(fields: [payslipId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("payroll_lines")
}

model SalaryHistory {
  id             String   @id @default(uuid())
  effectiveDate  DateTime
  previousSalary Float
  newSalary      Float
  currency       String
  reason         String? // e.g., "Annual Increment", "Promotion", "Adjustment"
  approvedBy     String?
  createdAt      DateTime @default(now())

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("salary_history")
}

model Timesheet {
  id            String          @id @default(uuid())
  date          DateTime
  clockIn       DateTime?
  clockOut      DateTime?
  regularHours  Float           @default(0)
  overtimeHours Float           @default(0)
  status        TimesheetStatus @default(PENDING)
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  approvedById String?
  approvedBy   User?   @relation(fields: [approvedById], references: [id])

  @@map("timesheets")
}

model Leave {
  id        String      @id @default(uuid())
  type      LeaveType
  startDate DateTime
  endDate   DateTime
  reason    String?
  status    LeaveStatus @default(PENDING)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  approvedById String?
  approvedBy   User?   @relation(fields: [approvedById], references: [id])

  @@map("leaves")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  table     String
  recordId  String
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

// Enums
enum UserRole {
  SUPER_ADMIN
  ADMIN
  PAYROLL_OFFICER
  MANAGER
  EMPLOYEE
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  CASUAL
}

enum PayFrequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
}

enum PayrollStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

enum TaxType {
  PAYE
  NSSA
  AIDS_LEVY
}

enum TimesheetStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LeaveType {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrollLineType {
  BASIC_SALARY
  ALLOWANCE
  OVERTIME
  BONUS
  DEDUCTION
  PAYE
  AIDS_LEVY
  NSSA_EMPLOYEE
  NSSA_EMPLOYER
  ADJUSTMENT
  OTHER
}
